#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from sqlalchemy.orm import Session
from app.database.database import SessionLocal, test_connection
from app.crud.user import crud_user, UserCreate
from app.crud.transaction import crud_transaction
from app.models.db.user import UserDB

def test_connection_db():
    """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
    print("üß™ –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î")
    if test_connection():
        print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ")
        return True
    return False

def test_create_user():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print("\nüß™ –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    db = SessionLocal()
    try:
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_in = UserCreate(
            username="test_user",
            email="test@example.com",
            password="test123",
            balance=50.0
        )
        user = crud_user.create(db, obj_in=user_in)
        print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: {user.username}, ID: {user.id}")
        print(f"   –ë–∞–ª–∞–Ω—Å: {user.balance}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        auth_user = crud_user.authenticate(db, "test_user", "test123")
        if auth_user:
            print(f"‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞")
        else:
            print(f"‚ùå –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å")
        
        # –û—á–∏—Å—Ç–∫–∞
        db.delete(user)
        db.commit()
        print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω")
        return True
    except Exception as e:
        db.rollback()
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False
    finally:
        db.close()

def test_balance():
    """–¢–µ—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º"""
    print("\nüß™ –¢–µ—Å—Ç 3: –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º")
    db = SessionLocal()
    try:
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_in = UserCreate(
            username="balance_test",
            email="balance@test.com",
            password="test123",
            balance=100.0
        )
        user = crud_user.create(db, obj_in=user_in)
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –±–∞–ª–∞–Ω—Å–æ–º: {user.balance}")
        
        # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        deposit = crud_transaction.create_deposit(
            db, user_id=user.id, amount=50.0, description="–¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ"
        )
        user = crud_user.update_balance(db, user.id, 50.0)
        print(f"‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ +50: {user.balance}")
        print(f"   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {deposit.id}, —Å—É–º–º–∞: {deposit.amount}")
        
        # –°–ø–∏—Å–∞–Ω–∏–µ - —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        withdrawal = crud_transaction.create_withdrawal(
            db, user_id=user.id, amount=30.0, description="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ"
        )
        user = crud_user.update_balance(db, user.id, -30.0)
        print(f"‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ -30: {user.balance}")
        print(f"   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {withdrawal.id}, —Å—É–º–º–∞: {withdrawal.amount}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        transactions = crud_transaction.get_by_user(db, user.id)
        print(f"‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {len(transactions)}")
        
        # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
        for t in transactions:
            print(f"   - {t.transaction_type.value}: {t.amount}, {t.description}")
        
        # –û—á–∏—Å—Ç–∫–∞
        for t in transactions:
            db.delete(t)
        db.delete(user)
        db.commit()
        print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã")
        return True
    except Exception as e:
        db.rollback()
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return False
    finally:
        db.close()

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("=" * 50)
    print("üöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•")
    print("=" * 50)
    
    tests = [
        ("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î", test_connection_db),
        ("–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", test_create_user),
        ("–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º", test_balance),
    ]
    
    results = []
    for name, test in tests:
        print(f"\n--- {name} ---")
        result = test()
        results.append(result)
    
    print("\n" + "=" * 50)
    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:")
    passed = sum(1 for r in results if r)
    total = len(results)
    print(f"   –ü—Ä–æ–π–¥–µ–Ω–æ: {passed}/{total}")
    
    if passed == total:
        print("\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    else:
        print("\n‚ö†Ô∏è  –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´")
    
    print("=" * 50)

if __name__ == "__main__":
    main()
